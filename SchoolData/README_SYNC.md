# 学校数据自动同步说明

## 功能说明

`sync-school-data.js` 脚本实现了 CSV 文件和本地数据库之间的**双向自动同步**：

1. **CSV → 数据库**：当 CSV 文件被修改时，自动导入到数据库
2. **数据库 → CSV**：当数据库数据被修改时，自动导出到 CSV 文件

## 使用方法

### 启动自动同步服务

```bash
npm run sync
```

或者直接运行：

```bash
node sync-school-data.js
```

### 停止同步服务

按 `Ctrl+C` 停止同步服务

## 同步机制

### 同步间隔

- 默认每 **5 秒**检查一次是否有变化
- CSV 文件变化检测有 **2 秒**的防抖延迟，避免频繁同步

### 同步逻辑

1. **CSV 文件变化检测**：
   - 使用文件系统监听（`fs.watch`）实时检测文件变化
   - 如果文件监听不可用，则使用定时轮询
   - 通过文件修改时间判断是否需要同步

2. **数据库变化检测**：
   - 通过比较数据库记录的 `updatedAt` 字段判断是否有变化
   - 定时轮询检查最新更新时间

3. **避免循环同步**：
   - 当数据库同步到 CSV 时，会更新 CSV 文件的最后修改时间记录
   - 避免触发 CSV 到数据库的同步，防止无限循环

## 其他相关命令

### 手动导入 CSV 到数据库

```bash
npm run import-csv SchoolData/SchoolData.csv
```

或：

```bash
node import-csv-all.js SchoolData/SchoolData.csv
```

### 手动导出数据库到 CSV

```bash
npm run export-csv
```

或：

```bash
node export-school-data.js
```

### 从服务器下载数据到 CSV

```bash
npm run download-csv
```

或：

```bash
node download-school-data.js
```

## 注意事项

1. **数据冲突处理**：
   - 如果 CSV 和数据库同时被修改，以**最后修改的时间**为准
   - 建议在修改数据时，只修改一个源（要么改 CSV，要么改数据库）

2. **文件路径**：
   - CSV 文件路径：`SchoolData/SchoolData.csv`
   - 可以通过修改脚本中的 `CSV_PATH` 变量更改路径

3. **数据库连接**：
   - 默认连接本地数据库：`mongodb://localhost:27017/mooyu`
   - 可通过环境变量 `MONGODB_URI` 指定其他数据库

4. **性能考虑**：
   - 同步操作是异步的，不会阻塞主进程
   - 大量数据同步可能需要一些时间，请耐心等待

## 日志输出

同步服务会输出以下信息：

- `[时间] 检测到CSV文件变化，开始同步到数据库...` - CSV 变化检测
- `✓ CSV → 数据库同步完成: 更新 X 所，创建 Y 所` - CSV 同步完成
- `[时间] 检测到数据库变化，开始同步到CSV...` - 数据库变化检测
- `✓ 数据库 → CSV同步完成: X 所学校` - 数据库同步完成
- 错误信息会以红色显示

## 开发建议

1. **开发环境**：建议在开发时启动同步服务，保持数据一致性
2. **生产环境**：生产环境建议使用定时任务或手动同步，避免资源浪费
3. **数据备份**：定期备份 CSV 文件和数据库，防止数据丢失

