# 学校官网验证功能说明

## 功能概述

在AI搜索学校信息时,新增了两个重要的验证步骤:

1. **官网地址可访问性测试** - 测试AI返回的学校官网地址是否能够正常访问
2. **学校名称验证** - 如果官网可以访问,读取官网上的学校名称并与用户输入的名称进行对比,如果不一致则使用官网上的名称

## 实现细节

### 1. 网站访问测试 (`testWebsiteAccess`)

**功能**: 测试指定的URL是否可以正常访问

**实现方式**:
- 使用Node.js原生的`http`/`https`模块发送GET请求
- 设置10秒超时时间
- 添加User-Agent模拟浏览器访问
- 处理HTTP重定向(3xx状态码)
- 返回访问结果,包括是否可访问、状态码、错误信息等

**返回结果**:
```javascript
{
  accessible: true/false,     // 是否可访问
  statusCode: 200,           // HTTP状态码(如果有)
  redirectUrl: '...',        // 重定向URL(如果有)
  error: '...'              // 错误信息(如果失败)
}
```

### 2. 学校名称验证 (`verifySchoolNameFromWebsite`)

**功能**: 从学校官网提取学校名称并与用户输入的名称进行对比

**实现方式**:
- 调用AI API访问学校官网
- AI从网站的title、logo区域、h1标题等位置提取学校名称
- 将提取的名称与用户输入的名称进行对比
- 返回对比结果,包括网站名称、是否匹配、置信度等

**返回结果**:
```javascript
{
  verified: true/false,           // 是否成功验证
  websiteName: '...',            // 网站上的学校名称
  isMatch: true/false,           // 是否匹配
  confidence: 'high/medium/low', // 置信度
  notes: '...',                  // 补充说明
  reason: '...'                  // 失败原因(如果失败)
}
```

### 3. 集成到学校信息查询 (`querySchoolBasicInfoFromAI`)

**工作流程**:

1. AI查询学校基础信息(包括官网地址)
2. 验证并清理官网地址
3. 如果官网地址存在:
   - **步骤1**: 测试官网是否可以访问
   - 如果可以访问:
     - **步骤2**: 从官网提取学校名称
     - **步骤3**: 对比名称
     - 如果不匹配或置信度低,使用官网上的名称替换AI返回的名称
   - 如果无法访问:
     - 清空网站地址字段
     - 记录错误日志
4. 返回最终的学校信息(使用验证后的名称和网址)

**日志输出示例**:
```
========== 开始验证学校网站 ==========
用户输入的学校名称: 上海中学国际部
AI返回的学校名称: 上海中学国际部
AI返回的网站地址: https://www.shsid.org
网站访问测试结果: {"accessible":true,"statusCode":200}
✓ 网站可以正常访问
学校名称验证结果: {"verified":true,"websiteName":"上海中学国际部","isMatch":true,"confidence":"high"}
✓ 学校名称验证一致 (置信度: high)
========== 验证完成 ==========
```

## 使用场景

### 场景1: 官网地址正确且学校名称一致
- AI返回: `{ name: "上海中学国际部", website: "https://www.shsid.org" }`
- 网站可访问: ✓
- 网站名称: "上海中学国际部"
- 匹配结果: 一致
- 最终结果: 保持AI返回的名称和网址

### 场景2: 官网地址正确但学校名称不一致
- AI返回: `{ name: "上海中学", website: "https://www.shsid.org" }`
- 网站可访问: ✓
- 网站名称: "上海中学国际部"
- 匹配结果: 不一致
- 最终结果: 使用官网名称"上海中学国际部"

### 场景3: 官网地址无法访问
- AI返回: `{ name: "某某学校", website: "https://invalid-url.com" }`
- 网站可访问: ✗
- 最终结果: 清空网站地址字段,保持AI返回的名称

### 场景4: AI未返回官网地址
- AI返回: `{ name: "某某学校", website: "" }`
- 最终结果: 不进行验证,直接返回AI的结果

## 技术要点

1. **最小化修改原则**: 
   - 只在必要时修改学校名称(名称不匹配或置信度低)
   - 只在网站无法访问时清空网站地址

2. **错误处理**:
   - 所有验证步骤都包含异常处理
   - 验证失败不会影响整体流程,只记录日志

3. **性能优化**:
   - 设置合理的超时时间(10秒)
   - 及时释放HTTP响应资源

4. **安全性**:
   - 使用User-Agent模拟正常浏览器访问
   - 对URL格式进行验证

## 日志监控

所有验证步骤都会输出详细的日志,便于调试和监控:

- `✓` 表示成功
- `✗` 表示失败
- `⚠` 表示警告(如名称不一致)

## 未来改进方向

1. 支持更多的网站提取方式(如直接解析HTML)
2. 添加网站可访问性的缓存机制
3. 支持更复杂的名称匹配算法
4. 添加网站响应时间监控

## 更新日期

2025-01-07

