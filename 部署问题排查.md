# 部署问题排查指南

## 问题描述

本地测试时功能正常，但上传到服务器后出现：
1. 对比表不一致
2. 课程（有/无）显示不一致

## 问题原因分析

### 1. 前端代码未完全同步
- **原因**：虽然 `update-website.sh` 脚本会构建并上传前端文件，但可能存在以下情况：
  - 浏览器缓存导致使用了旧的前端代码
  - 构建过程没有正确包含所有文件
  - 服务器上的文件没有完全替换

### 2. 对比表格缺少字段
- **已修复**：对比表格中缺少"学段设置"字段（kindergarten, primary, juniorHigh, seniorHigh）
- **已修复**：对比表格中缺少"隶属教育集团"字段（affiliatedGroup）

### 3. 字段映射不一致
- 前端代码中的字段处理逻辑需要与后端数据模型保持一致

## 解决方案

### 步骤 1：确保前后端代码都已更新

运行更新脚本（会自动更新前后端）：

```bash
./update-website.sh
```

这个脚本会：
1. ✅ 构建前端静态资源（`node build-assets.js`）
2. ✅ 上传构建后的前端文件到 `/var/www/mooyu-website/`
3. ✅ 上传后端代码 `server.js` 到 `/root/Mooyu/`
4. ✅ 重启后端服务（PM2）
5. ✅ 重启 Nginx

### 步骤 2：清除浏览器缓存

**重要**：浏览器可能缓存了旧的前端代码，导致显示不一致。

#### 方法 1：硬刷新（推荐）
- **Chrome/Edge**: `Ctrl+Shift+R` (Windows) 或 `Cmd+Shift+R` (Mac)
- **Firefox**: `Ctrl+F5` (Windows) 或 `Cmd+Shift+R` (Mac)
- **Safari**: `Cmd+Option+R`

#### 方法 2：清除浏览器缓存
1. 打开浏览器设置
2. 清除浏览数据
3. 选择"缓存的图片和文件"
4. 清除数据

#### 方法 3：使用无痕模式测试
- 打开无痕/隐私浏览模式
- 访问网站测试功能

### 步骤 3：验证文件是否已更新

#### 检查前端文件
```bash
# 检查服务器上的前端文件时间戳
ssh root@122.51.133.41 "ls -lh /var/www/mooyu-website/js/"

# 检查服务器上的 HTML 文件
ssh root@122.51.133.41 "ls -lh /var/www/mooyu-website/*.html"
```

#### 检查后端代码
```bash
# 检查服务器上的 server.js 时间戳
ssh root@122.51.133.41 "ls -lh /root/Mooyu/server.js"

# 检查后端服务是否正常运行
ssh root@122.51.133.41 "pm2 status mooyu"
```

### 步骤 4：检查 API 返回的数据

在浏览器开发者工具中检查 API 返回的数据格式：

```javascript
// 在浏览器控制台运行
fetch('https://mooyu.cc/api/schools')
  .then(r => r.json())
  .then(data => {
    console.log('学校数据示例:', data[0]);
    console.log('字段列表:', Object.keys(data[0]));
  });
```

确认返回的数据包含以下字段：
- ✅ `kindergarten`, `primary`, `juniorHigh`, `seniorHigh` (学段设置)
- ✅ `ibPYP`, `ibMYP`, `ibDP`, `ibCP` (IB课程)
- ✅ `aLevel`, `ap`, `canadian`, `australian`, `igcse` (其他课程)
- ✅ `affiliatedGroup` (隶属教育集团)

### 步骤 5：强制重新部署（如果问题仍然存在）

如果上述步骤后问题仍然存在，可以强制重新部署：

```bash
# 1. 删除服务器上的前端文件
ssh root@122.51.133.41 "rm -rf /var/www/mooyu-website/*"

# 2. 重新运行更新脚本
./update-website.sh

# 3. 验证文件已上传
ssh root@122.51.133.41 "ls -la /var/www/mooyu-website/"
```

## 已修复的问题

### ✅ 对比表格字段补充
- 添加了"学段设置"分类（幼儿园、小学、初中、高中）
- 添加了"隶属教育集团"字段到基本信息

### ✅ 字段显示逻辑
- 课程字段（有/无）的显示逻辑已统一
- 学段字段的显示逻辑已统一

## 预防措施

### 1. 使用版本控制
- 确保所有代码更改都提交到 Git
- 部署前检查 Git 状态

### 2. 部署检查清单
- [ ] 本地测试通过
- [ ] 运行 `./update-website.sh` 更新前后端
- [ ] 清除浏览器缓存或使用无痕模式测试
- [ ] 验证服务器上的文件时间戳
- [ ] 检查 API 返回的数据格式
- [ ] 测试对比表格显示
- [ ] 测试课程字段显示

### 3. 构建验证
在部署前，可以在本地验证构建结果：

```bash
# 构建前端资源
node build-assets.js

# 检查构建输出
ls -lh dist/js/
ls -lh dist/*.html

# 在本地预览（如果配置了本地服务器）
# 检查对比表格是否包含所有字段
```

## 常见问题

### Q: 为什么本地正常，服务器不正常？
**A**: 可能的原因：
1. 浏览器缓存了旧的前端代码
2. 服务器上的文件没有完全更新
3. 构建过程没有正确包含所有文件

### Q: 如何确认前端代码已更新？
**A**: 
1. 检查服务器文件时间戳
2. 在浏览器开发者工具中查看网络请求，检查 JS/CSS 文件的版本号（哈希值）
3. 使用无痕模式测试

### Q: 课程字段显示"无"但实际应该是"有"？
**A**: 检查：
1. 数据库中该字段的值是否为"有"（不是"Yes"、"true"等）
2. 前端代码的字段处理逻辑是否正确
3. API 返回的数据格式是否正确

## 联系支持

如果问题仍然存在，请提供：
1. 浏览器控制台的错误信息
2. 网络请求的响应数据
3. 服务器上的文件时间戳
4. 具体的错误现象截图
