# AI 评估体系说明

本文档详细说明学校AI评估体系的评分计算方法、权重分配、计算逻辑以及分值约束机制。

## 一、评估体系概述

### 1.1 评分体系结构

评估体系采用**三级评分结构**：
- **一级维度**：5个主要评估维度（学术卓越、全球升学、师资交互、全人成长、社会影响）
- **二级指标**：10个具体评估指标
- **三级维度**：每个二级指标下的细分评估维度（5分制评分）

### 1.2 总分构成

- **满分**：100分
- **总分计算**：所有二级指标得分相加
- **权重分配**：各二级指标权重之和为100%

## 二、评估维度与权重分配

### 2.1 一级维度权重分配

| 一级维度 | 权重 | 说明 |
|---------|------|------|
| 学术卓越 | 30% | 评估课程体系、国际认证及学术表现 |
| 全球升学 | 20% | 评估升学成果和规划体系 |
| 师资交互 | 15% | 评估师资稳定性和课堂文化 |
| 全人成长 | 20% | 评估活动系统和学生幸福感 |
| 社会影响 | 15% | 评估品牌和社区影响力 |
| **总计** | **100%** | - |

### 2.2 二级指标权重分配

#### 学术卓越维度（30%）

| 二级指标 | 权重 | 说明 |
|---------|------|------|
| 课程与融合 | 15% | 评估国际认证、国家课程融合及双语环境 |
| 学术评估 | 15% | 评估标准化考试、国际竞赛及研究能力培养 |

#### 全球升学维度（20%）

| 二级指标 | 权重 | 说明 |
|---------|------|------|
| 升学成果 | 10% | 评估顶尖大学录取率、专业多样性及毕业生表现 |
| 规划体系 | 10% | 评估升学顾问配置、职业规划教育及系统透明度 |

#### 师资交互维度（15%）

| 二级指标 | 权重 | 说明 |
|---------|------|------|
| 师资稳定 | 8% | 评估外教招聘标准、教师稳定性及专业发展 |
| 课堂文化 | 7% | 评估师生比例、探究式教学及文化包容度 |

#### 全人成长维度（20%）

| 二级指标 | 权重 | 说明 |
|---------|------|------|
| 活动系统 | 10% | 评估社团多样性、学生领导力及竞技体育参与 |
| 幸福感/生活 | 10% | 评估SEL课程、寄宿学院制及家长参与度 |

#### 社会影响维度（15%）

| 二级指标 | 权重 | 说明 |
|---------|------|------|
| 品牌与社区影响力 | 15% | 评估家长口碑、社会责任实践和行业地位 |

## 三、评分计算方法

### 3.1 三级维度评分（5分制）

每个三级维度按照评分标准进行**1-5分**的评分：

```
评分范围：1分（最低）到 5分（最高）
```

**评分标准示例：**
- **5分**：优秀表现，达到最高标准
- **4分**：良好表现，接近最高标准
- **3分**：中等表现，达到基本标准
- **2分**：较差表现，低于基本标准
- **1分**：很差表现，远低于基本标准

### 3.2 二级指标得分计算

**计算公式：**

```
二级指标得分 = Σ(三级维度得分 ÷ 5 × 三级维度权重)
```

**计算步骤：**
1. 对每个三级维度进行5分制评分（1-5分）
2. 计算每个三级维度的贡献值：`贡献值 = 三级维度得分 ÷ 5 × 三级维度权重`
3. 将所有三级维度的贡献值相加，得到二级指标得分
4. **限制条件**：二级指标得分不能超过其权重值

**计算示例：**

假设评估"课程声誉与体系成熟度"（权重25分）：

| 三级维度 | 权重 | 得分 | 贡献值计算 | 贡献值 |
|---------|------|------|-----------|--------|
| 课程体系权威性 | 10 | 4 | 4 ÷ 5 × 10 | 8.0 |
| 课程实施连贯性 | 10 | 5 | 5 ÷ 5 × 10 | 10.0 |
| 校本课程丰富度 | 5 | 3 | 3 ÷ 5 × 5 | 3.0 |
| **二级指标得分** | - | - | - | **21.0** |

### 3.3 总分计算

**计算公式：**

```
总分 = Σ(所有二级指标得分)
```

**计算步骤：**
1. 计算所有10个二级指标的得分
2. 将所有二级指标得分相加
3. **满分**：100分

**计算示例：**

| 二级指标 | 权重 | 得分 |
|---------|------|------|
| 课程声誉与体系成熟度 | 25 | 21.0 |
| 教学成果与影响力 | 20 | 16.0 |
| 大学认可度 | 15 | 12.0 |
| 升学成果 | 5 | 4.0 |
| 师生比 | 10 | 8.0 |
| 教师教育背景与稳定性 | 5 | 4.0 |
| 国际教员比例 | 5 | 3.5 |
| 国际学生比例 | 5 | 4.0 |
| 国际研究网络 | 5 | 3.0 |
| 品牌与社区影响力 | 5 | 4.0 |
| **总分** | **100** | **79.5** |

## 四、三级维度评分标准详解

### 4.1 学术卓越维度

#### 4.1.1 课程与融合（权重15分）

**三级维度1：国际认证级别与年限（权重5分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 获得IB全学段认证>10年；核心课程双语比例>60%；有自主研发的中西融合教研成果 |
| 4分 | 获得IB/AP/A-Level全学段认证>10年，且有CIS/WASC等额外机构认证 |
| 3分 | 拥有核心段认证（如仅高中IB），认证年限5-10年 |
| 2分 | 认证申请中、无认证或认证年限<3年 |
| 1分 | 无认证且课程不稳定 |

**三级维度2：国家课程融合方案（权重5分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 有成熟体系的"校本双语融合课程"，能清晰说明CNC与国际课程的对标点 |
| 4分 | 国际课程与国家课程平行授课，融合仅停留在课时分配 |
| 3分 | 课程两张皮，教学节奏混乱，学生压力极大 |
| 2分 | 无融合方案 |
| 1分 | 无融合方案且课程混乱 |

**三级维度3：双语环境浸润度（权重5分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 核心学科（数理化生）外教或双语教师授课比例>60%，校园全英文标识 |
| 4分 | 核心学科中文授课，仅ESL和艺术类由外教授课 |
| 3分 | 基本为全中文教学，仅有象征性的外教口语课 |
| 2分 | 无双语环境 |
| 1分 | 完全无双语环境 |

#### 4.1.2 学术评估（权重15分）

**三级维度1：标准化考试表现（权重6分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 标准化及AP/IB高分率全市场前5%；研究性论文/项目产出丰富 |
| 4分 | TOEFL平均分105+，SAT 1500+，IB平均分39+或AP 4分率>80% |
| 3分 | TOEFL平均分90-95，IB平均分34-35，符合行业平均水准 |
| 2分 | 标准化平均分低于全球平均水准，或学校拒绝公布相关数据 |
| 1分 | 无标准化考试数据 |

**三级维度2：国际竞赛获奖质量（权重5分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 经常有学生在AMC, MUN, VEX, HiMCM等竞赛获国家级/国际级奖项 |
| 4分 | 参赛人数多，但奖项多集中在区域级或者"参与奖" |
| 3分 | 极少组织参加国际主流竞赛（如AMC, VEX），无系统化辅导 |
| 2分 | 无竞赛参与 |
| 1分 | 完全无竞赛参与 |

**三级维度3：学术诚信与研究能力培养（权重4分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 开设EPQ/IPQ或深度探究项目，有学生作品展或校内学术期刊 |
| 4分 | 高年级有简单的探究项目，但缺乏系统的方法论培训 |
| 3分 | 纯刷题模式，学生无独立研究经历或产出 |
| 2分 | 无研究能力培养 |
| 1分 | 完全无研究能力培养 |

### 4.2 全球升学维度

#### 4.2.1 升学成果（权重10分）

**三级维度1：全球Top 30/50大学录取率（权重5分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 全球Top 30（或藤校/牛剑）录取率>30%；专业覆盖STEM、艺术、建筑、社会科学、哲学等8个以上领域；往届生反馈在海外大学适应极快 |
| 4分 | 全球Top 30（或藤校/牛剑）录取率>30%，且连续3年表现稳健 |
| 3分 | 录取集中在Top 50-80，Top 30占少数 |
| 2分 | 录取集中在Top 100之后，或多为预科、语言班录取 |
| 1分 | 无顶尖大学录取 |

**三级维度2：专业选择多样性（权重3分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 录取涵盖STEM、艺术、建筑、社会科学、哲学等8个以上领域 |
| 4分 | 录取专业高度集中在商科或经济（>70%为此类） |
| 3分 | 无法提供具体的专业分布，或专业极其单一 |
| 2分 | 无专业多样性数据 |
| 1分 | 完全无专业多样性 |

**三级维度3：毕业生大学第一年表现反馈（权重2分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | LinkedIn显示校友在名校表现优秀，且普遍反馈在校内英语水准完全对接大学 |
| 4分 | 偶有退学或转学记录，大部分校友评价平稳 |
| 3分 | 反馈大学适应极其困难，语言或学术诚信出现严重问题 |
| 2分 | 无反馈数据 |
| 1分 | 完全无反馈数据 |

#### 4.2.2 规划体系（权重10分）

**三级维度1：校内升学顾问配比（权重4分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 1对1规划从G9启动；拥有成熟的家长/校友职场导师资源；全流程系统化追踪 |
| 4分 | 拥有独立升学指导办，师生比<1:30，全是拥有5年+经验的全职顾问 |
| 3分 | 师生比1:50-60，顾问多由任课教师兼职，缺乏专业背景 |
| 2分 | 无升学办，或直接将升学业务外包给校外中介 |
| 1分 | 无升学指导 |

**三级维度2：职业生源早期教育（权重3分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 9年级即启动规划，每年有"职业日"邀请名企/大厂进行实习展示 |
| 4分 | 高二才开启规划，活动多为简单的大学生宣讲会 |
| 3分 | 仅提供申请文书的修改服务，无早期引导 |
| 2分 | 无职业规划教育 |
| 1分 | 完全无职业规划教育 |

**三级维度3：升学系统透明度（权重3分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 深度使用Cialfo/MaiaLearning等平台，家长可实时看到申请进度 |
| 4分 | 仅通过邮件或微信群沟通，申请进度查询不便 |
| 3分 | 申请过程完全"黑箱"，甚至不给学生申请账号 |
| 2分 | 无透明度 |
| 1分 | 完全无透明度 |

### 4.3 师资交互维度

#### 4.3.1 师资稳定（权重8分）

**三级维度1：外教全球招聘标准与资质匹配（权重3分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 硕士率>80%；留任率>90%；有充足预算支持教师参加全球学术研讨会(PD) |
| 4分 | 外教100%持证，硕士率>80%，来自英美加等母语国 |
| 3分 | 外教持证，硕士率50%，来源国教多元但非母语 |
| 2分 | 无证上岗，或以非母语国家留学生充当外教 |
| 1分 | 无外教 |

**三级维度2：教师离职率与合同续约率（权重3分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 教师年度流失率<10%，外教平均任职时长>3年 |
| 4分 | 年度流失率20%，符合行业一般规律 |
| 3分 | 教师频繁更换（>35%），学生一个学期换2个以上主课教师 |
| 2分 | 无稳定性数据 |
| 1分 | 完全无稳定性数据 |

**三级维度3：教师专业发展投入深度（权重2分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 每年有固定的人均学术差旅费，支持参加IB全球研讨会等高阶培训 |
| 4分 | 仅限校内的常规培训，极少参加外部学术会议 |
| 3分 | 完全没有教师培训预算 |
| 2分 | 无专业发展投入 |
| 1分 | 完全无专业发展投入 |

#### 4.3.2 课堂文化（权重7分）

**三级维度1：师生比例（权重3分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 极小班化；PBL项目作为核心评估方式；学生对教师的包容度评价极高 |
| 4分 | 全校平均师生比在1:6到1:8之间，班级<20人 |
| 3分 | 师生比1:12，班级25-30人 |
| 2分 | 师生比>1:20，大班授课，无个性化关注 |
| 1分 | 无师生比数据 |

**三级维度2：探究式教学执行质量（权重2分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 项目式学习(PBL)有明确的评估量表，且作为期末成绩的重要组成部分 |
| 4分 | 偶有PBL活动，但多为手抄报、模型展示等浅层学习 |
| 3分 | 纯讲授式，无项目式学习 |
| 2分 | 无探究式教学 |
| 1分 | 完全无探究式教学 |

**三级维度3：文化包容度与跨文化沟通评估（权重2分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 学生评价"老师非常尊重不同文化"，校园内有丰富的全球文化节 |
| 4分 | 偶有文化冲突，评价中性 |
| 3分 | 存在文化歧视、种族偏见或严重的沟通隔阂 |
| 2分 | 无文化包容度评估 |
| 1分 | 完全无文化包容度评估 |

### 4.4 全人成长维度

#### 4.4.1 活动系统（权重10分）

**三级维度1：社团多样性（权重4分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 社团>50个且由学生自主启动；参与高级别校际联赛；体育艺术设施达到顶级标准 |
| 4分 | >50个社团，社长拥有自主招募和预算权，活动报道密集 |
| 3分 | 20个社团，多为教师指定的"选修课"模式 |
| 2分 | 仅有2-3个体育队，社团形式趋同 |
| 1分 | 无社团系统 |

**三级维度2：学生领导力开发（权重3分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 学生会深度参与校规制定，有学生发起的社区影响力项目 |
| 4分 | 学生会多为辅助教师办活动，缺乏主动权 |
| 3分 | 只有班干部制度，无真正的学生自治机构 |
| 2分 | 无学生领导力开发 |
| 1分 | 完全无学生领导力开发 |

**三级维度3：竞技体育与校际联赛参与度（权重3分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 是ACAMIS, ISAC, FOBISIA等组织的核心成员，每月有校际比赛 |
| 4分 | 偶尔参加校际友谊赛，非大型组织成员 |
| 3分 | 基本无外赛，仅限校内活动会 |
| 2分 | 无竞技体育参与 |
| 1分 | 完全无竞技体育参与 |

#### 4.4.2 幸福感/生活（权重10分）

**三级维度1：社会情感学习课程体系（权重4分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 有系统SEL课；学院制荣誉感强；参与意愿度>95%（明确亮眼）；有24h心理咨询 |
| 4分 | 每周有固定的SEL（社会情感学习）课，专职心理教师配比达标 |
| 3分 | 有心理教师但只处理严重危机，无日常支持课程 |
| 2分 | 完全无心理健康关注，唯分数论 |
| 1分 | 无SEL课程 |

**三级维度2：寄宿学院制活跃度（权重3分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | House System深度嵌入日常，跨年级社交活跃，积分制完善 |
| 4分 | 仅在活动会分队，平时无跨年级互动 |
| 3分 | 无学院制 |
| 2分 | 无寄宿学院制 |
| 1分 | 完全无寄宿学院制 |

**三级维度3：家长参与度与家校沟通质量（权重3分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 家长会参与率>90%，有定期家长工作坊，家校沟通透明高效 |
| 4分 | 家长会参与率70-80%，有基本沟通渠道 |
| 3分 | 家长会参与率<50%，沟通不畅 |
| 2分 | 无家长参与机制 |
| 1分 | 完全无家长参与度数据 |

### 4.5 社会影响维度

#### 4.5.1 品牌与社区影响力（权重15分）

**三级维度1：家长口碑与满意度（权重5分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 满意度>95%，推荐率>80%，家长主动推荐 |
| 4分 | 满意度>90%，推荐率60-70% |
| 3分 | 满意度>85%，推荐率40-50% |
| 2分 | 满意度>80%，推荐率<30% |
| 1分 | 满意度<80% |

**三级维度2：社会责任实践（权重5分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | ≥3个长期学生主导的公益项目，有社会影响力 |
| 4分 | 有长期项目，定期参与 |
| 3分 | 有短期项目，偶尔参与 |
| 2分 | 偶尔参与，无系统化 |
| 1分 | 无社会责任实践 |

**三级维度3：行业标杆地位（权重5分）**

| 得分 | 评分标准 |
|------|---------|
| 5分 | 常被教育部门或同行作为示范校参观 |
| 4分 | 被权威媒体/机构报道 |
| 3分 | 区域内知名 |
| 2分 | 本地知名 |
| 1分 | 不知名 |

## 五、完整计算示例

### 5.1 示例：某学校完整评分计算

假设某学校在各项三级维度上的得分如下：

#### 科研维度

**课程声誉与体系成熟度（权重25分）**
- 课程体系权威性：4分（权重10分）→ 贡献值 = 4 ÷ 5 × 10 = 8.0
- 课程实施连贯性：5分（权重10分）→ 贡献值 = 5 ÷ 5 × 10 = 10.0
- 校本课程丰富度：3分（权重5分）→ 贡献值 = 3 ÷ 5 × 5 = 3.0
- **二级指标得分** = 8.0 + 10.0 + 3.0 = **21.0分**

**教学成果与影响力（权重20分）**
- 学术竞赛表现：4分（权重10分）→ 贡献值 = 4 ÷ 5 × 10 = 8.0
- 学生研究产出：3分（权重5分）→ 贡献值 = 3 ÷ 5 × 5 = 3.0
- 教师教研影响力：3分（权重5分）→ 贡献值 = 3 ÷ 5 × 5 = 3.0
- **二级指标得分** = 8.0 + 3.0 + 3.0 = **14.0分**

#### 升学维度

**大学认可度（权重15分）**
- 大学关系网络：4分（权重5分）→ 贡献值 = 4 ÷ 5 × 5 = 4.0
- 往届生口碑：4分（权重5分）→ 贡献值 = 4 ÷ 5 × 5 = 4.0
- 课程匹配度：5分（权重5分）→ 贡献值 = 5 ÷ 5 × 5 = 5.0
- **二级指标得分** = 4.0 + 4.0 + 5.0 = **13.0分**

**升学成果（权重5分）**
- 顶尖录取率：4分（权重2分）→ 贡献值 = 4 ÷ 5 × 2 = 1.6
- 整体升学率：5分（权重2分）→ 贡献值 = 5 ÷ 5 × 2 = 2.0
- 专业多样性：4分（权重1分）→ 贡献值 = 4 ÷ 5 × 1 = 0.8
- **二级指标得分** = 1.6 + 2.0 + 0.8 = **4.4分**

#### 教学维度

**师生比（权重10分）**
- 行政班平均人数：4分（权重6分）→ 贡献值 = 4 ÷ 5 × 6 = 4.8
- 个性化辅导机制：4分（权重4分）→ 贡献值 = 4 ÷ 5 × 4 = 3.2
- **二级指标得分** = 4.8 + 3.2 = **8.0分**

**教师教育背景与稳定性（权重5分）**
- 顶尖学历比例：4分（权重2分）→ 贡献值 = 4 ÷ 5 × 2 = 1.6
- 专业匹配度：4分（权重2分）→ 贡献值 = 4 ÷ 5 × 2 = 1.6
- 平均服务年限：3分（权重1分）→ 贡献值 = 3 ÷ 5 × 1 = 0.6
- **二级指标得分** = 1.6 + 1.6 + 0.6 = **3.8分**

#### 国际化维度

**国际教员比例（权重5分）**
- 外教资质与合规性：4分（权重3分）→ 贡献值 = 4 ÷ 5 × 3 = 2.4
- 外教课程参与度：3分（权重2分）→ 贡献值 = 3 ÷ 5 × 2 = 1.2
- **二级指标得分** = 2.4 + 1.2 = **3.6分**

**国际学生比例（权重5分）**
- 文化多样性：3分（权重3分）→ 贡献值 = 3 ÷ 5 × 3 = 1.8
- 跨文化融合活动：4分（权重2分）→ 贡献值 = 4 ÷ 5 × 2 = 1.6
- **二级指标得分** = 1.8 + 1.6 = **3.4分**

**国际研究网络（权重5分）**
- 实质性国际合作：3分（权重3分）→ 贡献值 = 3 ÷ 5 × 3 = 1.8
- 国际资源引入：3分（权重2分）→ 贡献值 = 3 ÷ 5 × 2 = 1.2
- **二级指标得分** = 1.8 + 1.2 = **3.0分**

#### 社会影响维度

**品牌与社区影响力（权重5分）**
- 家长口碑与满意度：4分（权重2分）→ 贡献值 = 4 ÷ 5 × 2 = 1.6
- 社会责任实践：3分（权重2分）→ 贡献值 = 3 ÷ 5 × 2 = 1.2
- 行业标杆地位：3分（权重1分）→ 贡献值 = 3 ÷ 5 × 1 = 0.6
- **二级指标得分** = 1.6 + 1.2 + 0.6 = **3.4分**

### 5.2 总分计算

| 二级指标 | 权重 | 得分 |
|---------|------|------|
| 课程声誉与体系成熟度 | 25 | 21.0 |
| 教学成果与影响力 | 20 | 14.0 |
| 大学认可度 | 15 | 13.0 |
| 升学成果 | 5 | 4.4 |
| 师生比 | 10 | 8.0 |
| 教师教育背景与稳定性 | 5 | 3.8 |
| 国际教员比例 | 5 | 3.6 |
| 国际学生比例 | 5 | 3.4 |
| 国际研究网络 | 5 | 3.0 |
| 品牌与社区影响力 | 5 | 3.4 |
| **总分** | **100** | **77.6** |

## 六、AI评估分值约束机制

### 6.1 约束机制概述

AI评估系统采用**双重约束机制**确保分值的有效性和合理性：

1. **提示词约束（软约束）**：通过详细的提示词指导AI生成符合规范的分值
2. **代码约束（硬约束）**：在保存数据前进行验证和自动修正

### 6.2 约束规则

#### 6.2.1 二级指标得分约束

**约束范围：** `[0, 权重值]`

**规则：**
- 每个二级指标的得分不能小于 0
- 每个二级指标的得分不能超过其权重值
- 权重值从 `evaluation-system.js` 配置文件中读取

**权重值列表：**

| 二级指标 | 权重值 | 得分范围 |
|---------|--------|---------|
| 课程声誉与体系成熟度 | 25 | [0, 25] |
| 教学成果与影响力 | 20 | [0, 20] |
| 大学认可度 | 15 | [0, 15] |
| 升学成果 | 5 | [0, 5] |
| 师生比 | 10 | [0, 10] |
| 教师教育背景与稳定性 | 5 | [0, 5] |
| 国际教员比例 | 5 | [0, 5] |
| 国际学生比例 | 5 | [0, 5] |
| 国际研究网络 | 5 | [0, 5] |
| 品牌与社区影响力 | 5 | [0, 5] |

#### 6.2.2 总分约束

**约束范围：** `[0, 100]`

**规则：**
- 总分不能小于 0
- 总分不能超过 100（满分）
- 总分应该是所有二级指标得分的总和

#### 6.2.3 数据有效性验证

**验证项：**
- 得分必须是有效的数字（不能是 `NaN`、`null`、`undefined`）
- 如果得分不是有效数字，该得分将被跳过，不会保存到数据库

### 6.3 实现机制

#### 6.3.1 代码实现位置

约束逻辑在 `server.js` 文件的 `saveAIScoringToDB()` 函数中实现。

#### 6.3.2 二级指标得分约束实现

```javascript
// 验证和约束得分范围
if (isNaN(score)) {
    console.warn(`⚠ 学校 "${schoolName}" 的指标 "${indicator}" 得分不是有效数字`);
    return; // 跳过无效得分
}

// 约束得分在 0 到权重值之间
const originalScore = score;
score = Math.max(0, Math.min(score, expectedWeight));

if (originalScore !== score) {
    console.warn(`⚠ 得分 ${originalScore} 超出范围 [0, ${expectedWeight}]，已约束为 ${score}`);
}
```

**处理逻辑：**
1. 检查得分是否为有效数字
2. 如果无效，记录警告并跳过该得分
3. 如果有效，使用 `Math.max(0, Math.min(score, weight))` 确保得分在范围内
4. 如果得分被修正，记录警告日志

#### 6.3.3 总分约束实现

```javascript
// 验证总分范围
if (isNaN(totalScore)) {
    console.warn(`⚠ 学校 "${schoolName}" 的总分不是有效数字`);
} else {
    // 约束总分在 0 到 100 之间
    const originalTotalScore = totalScore;
    totalScore = Math.max(0, Math.min(totalScore, 100));
    
    if (originalTotalScore !== totalScore) {
        console.warn(`⚠ 总分 ${originalTotalScore} 超出范围 [0, 100]，已约束为 ${totalScore}`);
    }
}
```

**处理逻辑：**
1. 检查总分是否为有效数字
2. 如果无效，记录警告但不保存
3. 如果有效，使用 `Math.max(0, Math.min(totalScore, 100))` 确保总分在范围内
4. 如果总分被修正，记录警告日志

#### 6.3.4 summary.totalScore 同步

**同步逻辑：**
- 确保 `summary.totalScore` 与约束后的 `totalScores` 保持一致
- 如果 `summary.totalScore` 与约束后的总分不一致，使用约束后的总分

```javascript
// 使用已经约束后的总分
if (updateData['AI评估_总分'] !== undefined) {
    const constrainedTotalScore = updateData['AI评估_总分'];
    if (summaryData.totalScore !== constrainedTotalScore) {
        summaryData.totalScore = constrainedTotalScore;
    }
}
```

### 6.4 提示词约束

#### 6.4.1 提示词中的约束说明

在 `buildScoringPrompt()` 函数中，通过提示词明确告诉AI：

```
**评分方法：**
1. 对每个三级维度按照5分制评分标准进行评分（1-5分）
2. 根据三级维度得分计算二级指标得分：二级指标得分 = Σ(三级维度得分 ÷ 5 × 三级维度权重)
3. 二级指标得分不能超过其权重值
```

#### 6.4.2 JSON格式示例中的范围标注

在提示词的JSON示例中，明确标注了每个指标的得分范围：

```json
{
  "indicator": "课程声誉与体系成熟度",
  "weight": 25,
  "scores": {
    "学校1名称": 得分数字（0-25之间）,
    "学校2名称": 得分数字（0-25之间）
  }
}
```

### 6.5 验证警告日志

#### 6.5.1 警告类型

系统会记录以下类型的警告：

1. **无效数字警告**：得分不是有效数字
2. **超出范围警告**：得分超出允许范围，已自动修正
3. **数据不一致警告**：`summary.totalScore` 与 `totalScores` 不一致

#### 6.5.2 警告日志格式

```
⚠ 学校 "学校名称" 的指标 "指标名称" 得分 26.0 超出范围 [0, 25]，已约束为 25.0
⚠ 学校 "学校名称" 的总分 105.0 超出范围 [0, 100]，已约束为 100.0
⚠ 学校 "学校名称" 分值验证警告 (2 项):
  - 指标 "课程声誉与体系成熟度" 得分超出范围
  - 总分超出范围
```

#### 6.5.3 日志位置

所有警告日志都会输出到：
- 服务器控制台（`console.warn`）
- 服务器日志文件（如果配置了日志记录）

### 6.6 数据保存流程

#### 6.6.1 完整流程

1. **接收AI返回结果**：从AI API获取评估结果
2. **验证和约束**：对每个得分进行验证和约束
3. **记录警告**：如果发现超出范围的值，记录警告日志
4. **保存数据**：将约束后的数据保存到数据库
5. **同步summary**：确保 `summary.totalScore` 与约束后的总分一致

#### 6.6.2 数据保存顺序

```
AI返回结果
    ↓
验证二级指标得分 → 约束到 [0, 权重值]
    ↓
验证总分 → 约束到 [0, 100]
    ↓
同步 summary.totalScore
    ↓
保存到数据库
```

### 6.7 约束效果

#### 6.7.1 保证数据有效性

- ✅ 所有保存的得分都在有效范围内
- ✅ 不会出现负数得分
- ✅ 不会出现超过权重值的得分
- ✅ 不会出现超过100分的总分

#### 6.7.2 数据一致性

- ✅ `summary.totalScore` 与 `totalScores` 保持一致
- ✅ 使用约束后的值，确保数据准确性

#### 6.7.3 可追溯性

- ✅ 所有超出范围的值都会被记录在日志中
- ✅ 可以追踪哪些数据被修正了
- ✅ 便于发现AI返回数据的问题

### 6.8 示例场景

#### 场景1：得分超出权重值

**AI返回：**
```json
{
  "indicator": "课程声誉与体系成熟度",
  "weight": 25,
  "scores": {
    "学校A": 26.0  // 超出权重值
  }
}
```

**处理结果：**
- 得分被约束为 25.0
- 记录警告日志：`⚠ 得分 26.0 超出范围 [0, 25]，已约束为 25.0`
- 保存到数据库：`AI评估_课程声誉与体系成熟度_得分 = 25.0`

#### 场景2：总分为负数

**AI返回：**
```json
{
  "totalScores": {
    "学校A": -5.0  // 负数
  }
}
```

**处理结果：**
- 总分被约束为 0.0
- 记录警告日志：`⚠ 总分 -5.0 超出范围 [0, 100]，已约束为 0.0`
- 保存到数据库：`AI评估_总分 = 0.0`

#### 场景3：总分为无效数字

**AI返回：**
```json
{
  "totalScores": {
    "学校A": "无效"  // 不是数字
  }
}
```

**处理结果：**
- 不保存总分
- 记录警告日志：`⚠ 学校 "学校A" 的总分不是有效数字: "无效"`
- 数据库中该字段保持原值或为 `null`

#### 场景4：summary.totalScore 不一致

**AI返回：**
```json
{
  "totalScores": {
    "学校A": 78.0
  },
  "summary": {
    "学校A": {
      "totalScore": 80.0  // 与 totalScores 不一致
    }
  }
}
```

**处理结果：**
- 如果 78.0 在范围内，使用 78.0
- 更新 `summary.totalScore = 78.0`
- 记录警告日志：`⚠ summary.totalScore (80.0) 与约束后的总分 (78.0) 不一致，使用约束后的总分`
- 保存到数据库：`AI评估_最终总结_JSON` 中的 `totalScore = 78.0`

## 七、重要注意事项

### 7.1 评分限制

1. **三级维度得分范围**：1-5分（整数）
2. **二级指标得分上限**：不能超过其权重值
   - 例如：权重为25分的二级指标，最高得分不能超过25分
3. **总分上限**：100分

### 7.2 权重固定性

- **权重值不可修改**：所有一级维度、二级指标和三级维度的权重都是固定的
- **权重总和验证**：
  - 一级维度权重总和 = 100%
  - 每个一级维度下的二级指标权重总和 = 该一级维度权重
  - 每个二级指标下的三级维度权重总和 = 该二级指标权重

### 7.3 评分原则

1. **客观性**：根据学校实际数据和表现进行评分
2. **一致性**：相同标准的学校应获得相同评分
3. **全面性**：综合考虑所有三级维度的表现
4. **准确性**：评分应准确反映学校在该指标上的实际水平

### 7.4 数据来源

评分应基于以下数据来源：
- 学校官方公开信息
- 教育部门统计数据
- 第三方评估报告
- 家长和学生反馈
- 行业媒体报道

### 7.5 约束机制注意事项

#### 7.5.1 约束是自动的

- 约束是**自动执行**的，不需要人工干预
- 超出范围的值会被**自动修正**，而不是拒绝保存
- 修正后的值会保存到数据库

#### 7.5.2 警告日志的重要性

- **必须监控警告日志**，及时发现AI返回数据的问题
- 如果频繁出现超出范围的值，可能需要：
  - 优化提示词
  - 检查评估体系配置
  - 检查AI API的返回质量

#### 7.5.3 数据修正的影响

- 修正后的数据会保存到数据库
- 前端显示的是修正后的数据
- 如果AI返回的数据质量高，修正应该很少发生

## 八、评估体系配置文件

评估体系配置定义在 `evaluation-system.js` 文件中，包含：
- 所有一级维度、二级指标和三级维度的定义
- 权重分配
- 评分标准

**修改评估体系**：如需修改评估体系，请编辑 `evaluation-system.js` 文件，修改后需要重启服务器生效。

## 九、技术实现细节

### 9.1 函数签名

```javascript
async function saveAIScoringToDB(schools, aiResult, evaluationSystem)
```

**参数说明：**
- `schools`: 学校对象数组
- `aiResult`: AI返回的评估结果
- `evaluationSystem`: 评估体系配置（用于获取权重值）

### 9.2 权重映射构建

```javascript
// 构建指标权重映射表
const indicatorWeightMap = {};
evaluationSystem.dimensions.forEach(dimension => {
    dimension.indicators.forEach(indicator => {
        indicatorWeightMap[indicator.name] = indicator.weight;
    });
});
```

### 9.3 约束函数

```javascript
// 约束到范围 [min, max]
const constrainValue = (value, min, max) => {
    return Math.max(min, Math.min(value, max));
};
```

实际使用：
```javascript
score = Math.max(0, Math.min(score, expectedWeight));
totalScore = Math.max(0, Math.min(totalScore, 100));
```

## 十、相关文档

- [AI评估数据映射说明.md](./AI评估数据映射说明.md) - 数据结构和字段映射说明
- [evaluation-system.js](./evaluation-system.js) - 评估体系配置文件

