# 测试网站验证功能指南

## 功能说明

当用户搜索一个不在数据库中的学校时,系统会:

1. **AI搜索** - 通过AI查询学校的基础信息,包括官网地址
2. **网站访问测试** - 测试AI返回的官网地址是否可以访问
3. **学校名称验证** - 如果官网可访问,读取官网上的学校名称
4. **名称对比** - 对比官网名称和用户输入的名称
5. **自动更正** - 如果名称不一致,使用官网上的正确名称

## 测试步骤

### 方法1: 通过Web界面测试

1. 访问 http://localhost:3000/schoolinsight.html
2. 在搜索框输入一个学校名称(例如: "上海协和双语")
3. 如果该学校不在数据库中,系统会:
   - 显示可能的学校名称列表供选择
   - 选择一个学校名称后,系统会通过AI查询信息
   - 后台会自动测试官网并验证学校名称
4. 打开浏览器控制台或查看服务器日志,可以看到验证过程的详细信息

### 方法2: 通过API直接测试

使用curl命令测试:

```bash
# 1. 搜索一个不存在的学校
curl -X GET "http://localhost:3000/api/schools?search=上海世外"

# 2. 如果返回possibleSchoolNames,选择一个创建
curl -X POST "http://localhost:3000/api/schools/create-from-name" \
  -H "Content-Type: application/json" \
  -d '{"schoolName": "上海世界外国语中学"}'
```

### 方法3: 查看服务器日志

服务器在验证过程中会输出详细的日志信息:

```
========== 开始验证学校网站 ==========
用户输入的学校名称: 上海世外
AI返回的学校名称: 上海世界外国语学校
AI返回的网站地址: https://www.wfl.sh.cn
网站访问测试结果: {"accessible":true,"statusCode":200}
✓ 网站可以正常访问
学校名称验证结果: {"verified":true,"websiteName":"上海世界外国语中学",...}
⚠ 学校名称不一致，使用网站名称: 上海世界外国语中学
  原名称: 上海世界外国语学校
  新名称: 上海世界外国语中学
  备注: 网站标题显示为"上海世界外国语中学"
========== 验证完成 ==========
```

## 测试场景

### 场景1: 正常情况(官网可访问,名称一致)

**测试学校**: 任何有正常官网的知名学校

**预期结果**:
- ✓ 网站可以正常访问
- ✓ 学校名称验证一致
- 使用AI返回的学校名称和网址

### 场景2: 名称不一致(官网可访问,但名称不同)

**测试方法**: 故意输入简称或不完整的学校名称

**预期结果**:
- ✓ 网站可以正常访问
- ⚠ 学校名称不一致
- 自动使用官网上的正确名称

### 场景3: 官网无法访问

**测试方法**: 
- 等待AI返回一个无效或失效的网站地址
- 或者手动修改数据库中某个学校的网址为无效地址后重新查询

**预期结果**:
- ✗ 网站无法访问
- 清空网站地址字段
- 保持AI返回的学校名称

### 场景4: AI未返回官网地址

**测试方法**: AI查询时未找到官网信息

**预期结果**:
- 跳过网站验证步骤
- 直接使用AI返回的其他信息

## 查看实时日志

### 方法1: 查看终端输出

如果你在终端直接运行 `npm start`,日志会直接显示在终端

### 方法2: 查看日志文件

```bash
# 如果配置了日志文件,可以实时查看
tail -f logs/server.log
```

### 方法3: 使用nodemon开发模式

```bash
npm run dev
```

## 注意事项

1. **网络连接**: 确保服务器可以访问外网,否则无法测试网站访问功能
2. **AI配额**: 每次验证都会调用AI API,注意API使用配额
3. **超时设置**: 网站访问测试有10秒超时限制
4. **错误处理**: 验证失败不会影响正常流程,只会记录日志

## 排查问题

### 问题1: 网站访问一直超时

**可能原因**:
- 服务器网络连接问题
- 目标网站响应慢或被防火墙拦截
- 超时时间设置太短

**解决方案**:
- 检查网络连接
- 增加超时时间(在server.js中修改timeout值)

### 问题2: AI无法提取网站名称

**可能原因**:
- 网站结构复杂,AI无法准确提取
- AI API配额不足或调用失败

**解决方案**:
- 查看AI返回的详细错误信息
- 检查API密钥是否有效

### 问题3: 名称验证总是不匹配

**可能原因**:
- 用户输入的是简称,而官网使用全称
- AI提取的名称不准确

**解决方案**:
- 这是正常情况,系统会自动使用官网的正确名称
- 如果需要调整匹配逻辑,可以修改verifySchoolNameFromWebsite函数

## 功能限制

1. **仅在创建新学校时验证** - 已存在的学校不会重新验证
2. **依赖AI判断** - 名称对比依赖AI的判断能力
3. **网络环境依赖** - 需要服务器能够访问目标网站
4. **不支持需要登录的网站** - 只能访问公开页面

## 未来改进

1. 支持批量验证已有学校的网站
2. 添加网站可访问性的定期检查
3. 支持手动干预名称对比结果
4. 缓存验证结果以减少重复验证

## 更新时间

2026-01-07

