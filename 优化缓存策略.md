# 缓存优化策略说明

## ✅ 当前已实现的哈希指纹机制

您的项目**已经实现了完整的哈希指纹机制**，可以有效避免缓存问题：

### 1. 构建系统（build-assets.js）

- ✅ **CSS/JS 文件**：自动添加 SHA256 哈希值
  - `css/style.css` → `css/style.6a7f2944.css`
  - `js/schoolinsight.js` → `js/schoolinsight.859a394a.js`
  
- ✅ **图片资源**：自动添加哈希值
  - `images/logo.png` → `images/logo.abc12345.png`
  
- ✅ **HTML 文件**：自动替换所有资源引用为带哈希的文件名

### 2. Nginx 缓存配置

当前配置已经优化：

```nginx
# HTML 文件：不缓存，确保总是获取最新版本
location ~* \.html$ {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
}

# 带哈希的静态资源：长期缓存（因为文件名变了就是新文件）
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

## 🎯 工作原理

### 为什么哈希可以避免缓存问题？

1. **文件内容改变 → 哈希值改变 → 文件名改变**
   - 当您修改 `schoolinsight.js` 后，构建系统会生成新的哈希
   - 例如：`schoolinsight.859a394a.js` → `schoolinsight.xyz78901.js`
   - 浏览器看到的是**完全不同的文件名**，会重新下载

2. **HTML 文件不缓存**
   - HTML 文件设置了 `no-cache`，浏览器每次都会检查是否有新版本
   - HTML 中引用的资源文件名已经包含哈希，确保获取正确版本

3. **静态资源长期缓存**
   - 因为文件名包含哈希，可以安全地设置长期缓存
   - 旧文件不会被覆盖，新文件是新文件名

## 📋 验证哈希机制是否工作

### 方法 1：检查构建输出

```bash
# 构建项目
node build-assets.js

# 检查 dist 目录中的文件
ls -lh dist/js/
ls -lh dist/css/

# 检查 HTML 文件中的引用
grep -E "\.(js|css)" dist/schoolinsight.html
```

应该看到：
- `css/style.6a7f2944.css`（哈希值）
- `js/schoolinsight.859a394a.js`（哈希值）

### 方法 2：检查浏览器网络请求

1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 刷新页面
4. 查看 JS/CSS 文件的请求 URL

应该看到文件名包含哈希值，例如：
- `https://mooyu.cc/js/schoolinsight.859a394a.js`

### 方法 3：修改文件后验证

```bash
# 1. 修改 js/schoolinsight.js（添加一个注释）
echo "// Updated" >> js/schoolinsight.js

# 2. 重新构建
node build-assets.js

# 3. 检查新的哈希值
ls -lh dist/js/schoolinsight.*.js

# 应该看到新的哈希值（与之前不同）
```

## 🔧 进一步优化建议

### 1. 确保 HTML 文件正确更新

虽然 HTML 文件设置了不缓存，但为了更可靠，可以：

**选项 A：添加版本号到 HTML 文件名（不推荐）**
- 会破坏 URL 结构

**选项 B：在 HTML 中添加版本号查询参数（推荐）**
- 在 HTML 的 `<head>` 中添加：
```html
<meta name="version" content="20240101">
```

**选项 C：使用 ETag（已由 Nginx 自动处理）**
- Nginx 默认会为文件生成 ETag
- 浏览器会发送 `If-None-Match` 头检查是否有更新

### 2. 添加构建版本信息

可以在构建时生成版本文件：

```javascript
// 在 build-assets.js 中添加
const buildVersion = Date.now();
fs.writeFileSync(
  path.join(distDir, 'version.json'),
  JSON.stringify({ version: buildVersion, timestamp: new Date().toISOString() })
);
```

### 3. 服务端版本检查

可以在 HTML 中添加版本检查脚本：

```html
<script>
  // 检查版本更新
  fetch('/version.json?t=' + Date.now())
    .then(r => r.json())
    .then(data => {
      const lastVersion = localStorage.getItem('appVersion');
      if (lastVersion && lastVersion !== data.version) {
        // 提示用户刷新
        if (confirm('发现新版本，是否刷新页面？')) {
          location.reload();
        }
      }
      localStorage.setItem('appVersion', data.version);
    });
</script>
```

## 🚨 常见问题排查

### Q: 为什么修改后还是看到旧代码？

**A**: 可能的原因：

1. **浏览器缓存了 HTML 文件**
   - 解决：硬刷新（Ctrl+Shift+R 或 Cmd+Shift+R）
   - 或使用无痕模式测试

2. **构建没有执行**
   - 解决：确保运行了 `node build-assets.js`
   - 检查 `dist/` 目录中的文件时间戳

3. **文件没有上传到服务器**
   - 解决：检查 `update-website.sh` 是否成功执行
   - 验证服务器上的文件时间戳

4. **Nginx 配置未生效**
   - 解决：重启 Nginx `systemctl restart nginx`
   - 检查配置语法 `nginx -t`

### Q: 哈希值没有变化？

**A**: 检查：

1. 文件内容是否真的改变了
2. 构建脚本是否正常执行
3. 是否有多个构建输出目录

### Q: 如何强制清除所有缓存？

**A**: 

1. **浏览器端**：
   - 硬刷新：Ctrl+Shift+R
   - 清除浏览器缓存
   - 使用无痕模式

2. **服务器端**：
   ```bash
   # 删除服务器上的所有文件
   ssh root@122.51.133.41 "rm -rf /var/www/mooyu-website/*"
   
   # 重新上传
   ./update-website.sh
   ```

## ✅ 最佳实践

1. **每次部署前**：
   - ✅ 运行 `node build-assets.js` 生成带哈希的文件
   - ✅ 运行 `./update-website.sh` 上传到服务器
   - ✅ 验证服务器上的文件时间戳

2. **测试时**：
   - ✅ 使用硬刷新或无痕模式
   - ✅ 检查浏览器网络请求中的文件名
   - ✅ 验证功能是否正常

3. **监控**：
   - ✅ 检查构建日志
   - ✅ 验证文件哈希值变化
   - ✅ 确认服务器文件更新

## 📊 总结

您的项目**已经实现了完整的哈希指纹机制**，这是避免缓存问题的最佳实践：

- ✅ CSS/JS/图片文件都有哈希值
- ✅ HTML 文件自动更新引用
- ✅ Nginx 配置已优化
- ✅ 静态资源长期缓存
- ✅ HTML 文件不缓存

**只要确保每次部署时都运行构建脚本，哈希机制就会自动工作，避免缓存问题！**
