# AI评估分数稳定性优化实施总结

## 已实施的优化

### 1. 提示词优化（核心改进）

**位置**：`server.js` 的 `buildScoringPrompt` 函数

**改进内容**：
- 添加了"核心评分原则"部分，明确要求AI进行**绝对评分**，而非相对评分
- 强调基于评估标准的客观评分，而非对比组平均水平
- 要求同一所学校在不同对比组合中保持分数一致性（允许±1分误差）

**预期效果**：
- 直接解决分数因对比学校不同而变化的问题
- 提高评估结果的一致性和可信度

### 2. 历史分数聚合机制

**位置**：`server.js` 的 `saveAIScoringToDB` 函数

**实现功能**：
1. **历史评估记录**：每次评估都会保存到 `AI评估_历史记录` 字段
   - 记录时间戳、总分、各指标得分、对比组信息
   - 保留最近20条记录

2. **加权平均计算**：
   - 新评估权重：60%
   - 历史平均权重：40%
   - 随着评估次数增加，分数会趋于稳定

3. **分数稳定性指标**：
   - 计算历史分数的标准差
   - 标准化到0-100范围（标准差越小，稳定性越高）
   - 保存在 `AI评估_分数稳定性` 字段

4. **评估次数统计**：
   - 记录在 `AI评估_评估次数` 字段
   - 可用于判断评估结果的可靠性

### 3. 数据库结构扩展

**新增字段**：
```javascript
'AI评估_历史记录': [{ 
    timestamp: Date,
    totalScore: Number,
    indicatorScores: Object,
    comparisonGroup: [String]
}],
'AI评估_评估次数': Number,
'AI评估_分数稳定性': Number
```

## 使用说明

### 查看历史评估记录

可以通过以下方式查看学校的历史评估记录：

```javascript
const school = await School.findById(schoolId);
console.log('评估次数:', school['AI评估_评估次数']);
console.log('分数稳定性:', school['AI评估_分数稳定性']);
console.log('历史记录:', school['AI评估_历史记录']);
```

### 分数稳定性解读

- **分数稳定性 90-100**：非常稳定，分数变化很小
- **分数稳定性 70-89**：较为稳定，有轻微波动
- **分数稳定性 50-69**：中等稳定，有一定波动
- **分数稳定性 < 50**：不够稳定，分数变化较大

**建议**：
- 评估次数 < 3次：分数可能不够稳定，建议多次评估
- 评估次数 ≥ 3次：分数应该趋于稳定
- 如果稳定性 < 50，可能需要检查评估数据或提示词

## 监控建议

### 1. 分数一致性检查

可以定期检查同一所学校在不同对比组中的分数差异：

```javascript
// 检查学校A在不同对比组中的分数
const records = school['AI评估_历史记录'];
const scores = records.map(r => r.totalScore);
const maxDiff = Math.max(...scores) - Math.min(...scores);
console.log(`分数差异: ${maxDiff}分`);
```

**目标**：分数差异 < 3分（95%置信区间）

### 2. 评估质量监控

- 监控评估次数分布
- 监控分数稳定性分布
- 识别异常评估（分数波动过大）

### 3. 用户反馈收集

- 收集用户对评估结果的反馈
- 识别分数不一致的情况
- 持续优化提示词

## 后续优化方向

### 短期（1-2周）
1. **监控效果**：观察实施后的分数一致性改善情况
2. **调整权重**：根据实际效果调整加权平均的权重比例
3. **异常检测**：识别并标记异常评估（分数波动过大）

### 中期（1-2月）
1. **参考学校池**：如果效果不佳，考虑实施参考学校池方案
2. **分数标准化**：考虑使用z-score标准化
3. **用户界面**：在前端显示评估次数和分数稳定性

### 长期（3-6月）
1. **机器学习优化**：使用历史数据训练模型，预测更稳定的分数
2. **多模型集成**：使用多个AI模型评估，取平均值
3. **人工审核机制**：对关键学校进行人工审核和校准

## 注意事项

1. **向后兼容**：现有学校数据会自动兼容，新字段为可选
2. **性能影响**：历史记录保留20条，对性能影响很小
3. **存储空间**：每条历史记录约1-2KB，20条约20-40KB，影响可忽略
4. **首次评估**：首次评估时没有历史数据，分数可能仍有波动，这是正常的

## 验证方法

### 测试步骤
1. 选择同一所学校（如学校A）
2. 与不同的学校进行对比（学校B、学校C、学校D）
3. 记录每次评估的分数
4. 检查分数差异是否在合理范围内（< 3分）

### 预期结果
- 实施前：分数差异可能 > 5分
- 实施后：分数差异应该 < 3分（评估次数 ≥ 3次后）

## 问题排查

### 如果分数仍然不稳定

1. **检查提示词**：确认提示词中"绝对评分"的要求是否明确
2. **检查评估次数**：评估次数 < 3次时，分数可能不够稳定
3. **检查数据质量**：学校基础信息是否完整
4. **检查AI模型**：不同AI模型可能有不同的评分标准

### 如果加权平均效果不佳

可以调整权重比例：
- 当前：新评估60%，历史40%
- 可尝试：新评估50%，历史50%（更保守）
- 或：新评估70%，历史30%（更激进）

## 技术支持

如有问题，请检查：
1. 服务器日志中的评估记录
2. 数据库中的历史记录字段
3. AI API返回的原始分数
